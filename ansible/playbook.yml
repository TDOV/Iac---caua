- name: Deploy da Aplicação com Docker
  hosts: all
  become: yes
  gather_facts: yes # Habilitar para pegar a variável ansible_distribution_release

  handlers:
    - name: Start Docker Service
      service:
        name: docker
        state: started
        enabled: yes

  tasks:
    - name: "Instalar pré-requisitos (apt, git, python-pip)"
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - git
          - python3-pip
        state: present
        update_cache: yes

    - name: "Adicionar chave GPG oficial do Docker"
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: "Adicionar repositório Docker"
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: "Instalar Docker Engine"
      apt:
        name: docker-ce
        state: present
        update_cache: yes
      notify: Start Docker Service

    - name: "Instalar Docker SDK para Ansible"
      pip:
        name: docker

    - name: "Adicionar usuário ao grupo docker"
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: "Garantir que o serviço Docker está rodando"
      service:
        name: docker
        state: started
        enabled: yes

    - name: "Reset SSH connection para aplicar mudanças de grupo"
      meta: reset_connection

    - name: "Verificar se Docker está funcionando"
      command: docker info
      become: yes
      register: docker_info
      
    - name: "Criar rede Docker para a aplicação"
      command: docker network create app_network --driver bridge
      become: yes
      ignore_errors: yes  # Ignora erro se a rede já existir

    - name: "Criar diretório para o código-fonte"
      file:
        path: "/opt/app_source"
        state: directory

    # --- Backend ---
    - name: "Clonar repositório do Backend (branch: {{ app_config.backend.branch }})"
      git:
        repo: "{{ app_config.backend.repo }}"
        dest: "/opt/app_source/backend"
        version: "{{ app_config.backend.branch }}"
        force: yes

    - name: "Buildar imagem Docker do Backend"
      command: docker build -t {{ app_config.backend.container_name }}:latest /opt/app_source/backend
      become: yes

    - name: "Iniciar container do Backend"
      command: >
        docker run -d --name {{ app_config.backend.container_name }}
        --network app_network
        --restart always
        -p 8080:8080
        {{ app_config.backend.container_name }}:latest
      become: yes
      ignore_errors: yes  # Ignora erro se container já existir

    # --- Frontend ---
    - name: "Clonar repositório do Frontend (branch: {{ app_config.frontend.branch }})"
      git:
        repo: "{{ app_config.frontend.repo }}"
        dest: "/opt/app_source/frontend"
        version: "{{ app_config.frontend.branch }}"
        force: yes

    - name: "Buildar imagem Docker do Frontend"
      command: docker build -t {{ app_config.frontend.container_name }}:latest /opt/app_source/frontend
      become: yes

    - name: "Iniciar container do Frontend"
      command: >
        docker run -d --name {{ app_config.frontend.container_name }}
        --network app_network
        --restart always
        -p 80:80
        -e BACKEND_URL=http://{{ app_config.backend.container_name }}:8080
        {{ app_config.frontend.container_name }}:latest
      become: yes
      ignore_errors: yes  # Ignora erro se container já existir